<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>g≈Çodnajestem üçï</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  :root {
    --bg: #FFFBF5;
    --bg2: #FFF5E8;
    --text: #1A1208;
    --text2: #6B5B45;
    --accent: #FF6B35;
    --accent-light: #FFE4D6;
    --green: #4CAF7D;
    --green-light: #D6F5E3;
    --pink: #FF8FA3;
    --pink-light: #FFE0E6;
    --card-bg: #FFFFFF;
    --shadow: 0 4px 24px rgba(0,0,0,0.08);
    --radius: 20px;
    --font: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
  }

  html, body {
    height: 100%;
    font-family: var(--font);
    background: var(--bg);
    color: var(--text);
    overflow: auto;
  }

  #app {
    max-width: 420px;
    margin: 0 auto;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    position: relative;
  }

  /* SCREENS */
  .screen {
    display: none;
    flex-direction: column;
    min-height: 100vh;
    padding: 24px 20px;
    animation: fadeIn 0.3s ease;
  }
  .screen.active { display: flex; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* LANDING */
  #screen-landing {
    justify-content: center;
    align-items: center;
    text-align: center;
    gap: 0;
  }

  .landing-emoji {
    font-size: 72px;
    margin-bottom: 12px;
    animation: bounce 2s ease-in-out infinite;
  }

  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
  }

  .landing-title {
    font-size: 36px;
    font-weight: 800;
    letter-spacing: -1.5px;
    color: var(--text);
    margin-bottom: 8px;
  }

  .landing-sub {
    font-size: 16px;
    color: var(--text2);
    margin-bottom: 40px;
    line-height: 1.5;
  }

  .btn-primary {
    width: 100%;
    padding: 18px 24px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: var(--radius);
    font-size: 17px;
    font-weight: 700;
    cursor: pointer;
    transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.15s ease;
    margin-bottom: 12px;
  }

  .btn-primary:active { transform: scale(0.96); }
  .btn-primary:hover { box-shadow: 0 8px 32px rgba(255,107,53,0.35); transform: translateY(-2px); }

  .btn-secondary {
    width: 100%;
    padding: 16px 24px;
    background: transparent;
    color: var(--text2);
    border: 2px solid #E8DDD0;
    border-radius: var(--radius);
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s ease;
  }
  .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }

  /* SETUP */
  #screen-setup {
    gap: 0;
    overflow-y: auto;
    height: auto;
    min-height: 100vh;
    padding-bottom: 40px;
  }

  .screen-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 28px;
  }

  .back-btn {
    width: 40px; height: 40px;
    background: var(--bg2);
    border: none;
    border-radius: 12px;
    font-size: 18px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }

  .screen-title {
    font-size: 22px;
    font-weight: 800;
    letter-spacing: -0.5px;
  }

  .label {
    font-size: 14px;
    font-weight: 600;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 10px;
    margin-top: 20px;
  }

  .avatar-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-bottom: 4px;
  }

  .avatar-btn {
    aspect-ratio: 1;
    background: var(--bg2);
    border: 3px solid transparent;
    border-radius: 16px;
    font-size: 28px;
    cursor: pointer;
    transition: all 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
    display: flex; align-items: center; justify-content: center;
  }

  .avatar-btn:hover { transform: scale(1.1); }
  .avatar-btn.selected {
    border-color: var(--accent);
    background: var(--accent-light);
    transform: scale(1.12);
  }

  .text-input {
    width: 100%;
    padding: 14px 18px;
    background: var(--card-bg);
    border: 2px solid #E8DDD0;
    border-radius: 14px;
    font-size: 16px;
    font-family: var(--font);
    color: var(--text);
    outline: none;
    transition: border-color 0.15s;
  }
  .text-input:focus { border-color: var(--accent); }

  .players-row {
    display: flex;
    gap: 10px;
  }

  .player-count-btn {
    flex: 1;
    padding: 14px 8px;
    background: var(--bg2);
    border: 2px solid transparent;
    border-radius: 14px;
    font-size: 20px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
    text-align: center;
  }

  .player-count-btn span {
    display: block;
    font-size: 11px;
    font-weight: 500;
    color: var(--text2);
    margin-top: 2px;
  }

  .player-count-btn.selected {
    border-color: var(--accent);
    background: var(--accent-light);
  }

  .btn-primary-sm {
    padding: 16px 24px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: var(--radius);
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
    margin-top: 24px;
    width: 100%;
  }
  .btn-primary-sm:hover { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(255,107,53,0.35); }
  .btn-primary-sm:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  /* JOIN */
  #screen-join { gap: 0; height: auto; min-height: 100vh; padding-bottom: 40px; overflow-y: auto; }

  .join-code-input {
    text-align: center;
    font-size: 32px;
    font-weight: 800;
    letter-spacing: 6px;
    text-transform: uppercase;
  }

  /* WAITING */
  #screen-waiting {
    gap: 0;
    height: auto;
    min-height: 100vh;
    padding-bottom: 40px;
    overflow-y: auto;
  }

  .session-code-box {
    background: var(--bg2);
    border-radius: 18px;
    padding: 20px;
    text-align: center;
    margin-bottom: 24px;
  }

  .session-code-label {
    font-size: 13px;
    font-weight: 600;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
  }

  .session-code {
    font-size: 40px;
    font-weight: 900;
    letter-spacing: 8px;
    color: var(--accent);
  }

  .share-hint {
    font-size: 13px;
    color: var(--text2);
    margin-top: 8px;
  }

  .copy-link-btn {
    margin-top: 10px;
    padding: 8px 16px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
  }

  .players-list {
    flex: 1;
    overflow-y: auto;
  }

  .players-label {
    font-size: 14px;
    font-weight: 600;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 12px;
  }

  .player-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    background: var(--card-bg);
    border-radius: 16px;
    margin-bottom: 8px;
    animation: slideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: var(--shadow);
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .player-avatar { font-size: 28px; }

  .player-name {
    font-size: 16px;
    font-weight: 700;
    flex: 1;
  }

  .host-badge {
    font-size: 11px;
    font-weight: 600;
    color: var(--accent);
    background: var(--accent-light);
    padding: 4px 8px;
    border-radius: 8px;
  }

  .waiting-slot {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    border: 2px dashed #E8DDD0;
    border-radius: 16px;
    margin-bottom: 8px;
    color: var(--text2);
    font-size: 15px;
  }

  .start-btn-container {
    padding-top: 16px;
  }

  .waiting-note {
    text-align: center;
    font-size: 14px;
    color: var(--text2);
    margin-top: 8px;
  }

  /* GAME */
  #screen-game {
    padding: 0;
    position: relative;
    height: 100vh;
    overflow: hidden;
  }

  .game-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 20px 12px;
    gap: 8px;
  }

  .avatars-row {
    display: flex;
    gap: -4px;
  }

  .avatar-chip {
    width: 36px; height: 36px;
    background: var(--bg2);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    position: relative;
    border: 2px solid var(--bg);
    margin-left: -6px;
    transition: all 0.3s ease;
  }
  .avatar-chip:first-child { margin-left: 0; }
  .avatar-chip.done { background: var(--green-light); }
  .avatar-chip.done::after {
    content: '‚úì';
    position: absolute;
    bottom: -2px; right: -2px;
    width: 16px; height: 16px;
    background: var(--green);
    color: white;
    border-radius: 50%;
    font-size: 9px;
    font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    line-height: 16px;
    text-align: center;
  }

  .timer {
    font-size: 20px;
    font-weight: 800;
    color: var(--text);
    background: var(--bg2);
    padding: 8px 14px;
    border-radius: 12px;
    font-variant-numeric: tabular-nums;
    transition: color 0.3s;
  }
  .timer.urgent { color: var(--accent); animation: pulse 0.8s ease-in-out infinite; }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

  .progress-text {
    font-size: 13px;
    font-weight: 600;
    color: var(--text2);
  }

  .card-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 0 20px;
    position: relative;
    overflow: hidden;
  }

  .provocation {
    background: var(--bg2);
    border-radius: 16px;
    padding: 14px 18px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text2);
    text-align: center;
    margin-bottom: 16px;
    max-width: 340px;
    animation: fadeIn 0.4s ease;
  }

  .swipe-card {
    width: 100%;
    max-width: 340px;
    background: var(--card-bg);
    border-radius: 28px;
    box-shadow: 0 8px 48px rgba(0,0,0,0.12);
    padding: 40px 32px;
    text-align: center;
    cursor: grab;
    user-select: none;
    touch-action: none;
    transition: box-shadow 0.15s ease;
    position: relative;
    will-change: transform;
  }

  .swipe-card:active { cursor: grabbing; }

  .card-emoji { font-size: 80px; margin-bottom: 16px; display: block; }
  .card-name { font-size: 28px; font-weight: 800; letter-spacing: -0.5px; margin-bottom: 8px; }
  .card-tagline { font-size: 15px; color: var(--text2); }

  .vote-indicator {
    position: absolute;
    top: 24px;
    padding: 10px 20px;
    border-radius: 14px;
    font-size: 20px;
    font-weight: 900;
    opacity: 0;
    transition: opacity 0.1s;
    pointer-events: none;
  }

  .vote-yes {
    left: 20px;
    background: var(--green-light);
    color: var(--green);
    border: 3px solid var(--green);
    transform: rotate(-12deg);
  }

  .vote-no {
    right: 20px;
    background: var(--pink-light);
    color: #E91E63;
    border: 3px solid #E91E63;
    transform: rotate(12deg);
  }

  .swipe-hints {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    max-width: 340px;
    margin-top: 20px;
    padding: 0 8px;
    gap: 12px;
  }

  .vote-btn {
    flex: 1;
    padding: 16px 12px;
    border: none;
    border-radius: 20px;
    font-size: 17px;
    font-weight: 800;
    cursor: pointer;
    transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.15s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }

  .vote-btn:active { transform: scale(0.93) !important; }

  .vote-btn-no {
    background: var(--pink-light);
    color: #E91E63;
  }
  .vote-btn-no:hover { transform: scale(1.04); box-shadow: 0 6px 20px rgba(233,30,99,0.2); }

  .vote-btn-yes {
    background: var(--green-light);
    color: var(--green);
  }
  .vote-btn-yes:hover { transform: scale(1.04); box-shadow: 0 6px 20px rgba(76,175,125,0.2); }

  .vote-btn-emoji { font-size: 24px; }
  .vote-btn-label { font-size: 13px; font-weight: 700; letter-spacing: 0.5px; }

  .waiting-votes {
    text-align: center;
    padding: 40px 20px;
  }

  .waiting-votes-title {
    font-size: 22px;
    font-weight: 800;
    margin-bottom: 8px;
  }

  .waiting-votes-sub { font-size: 15px; color: var(--text2); }

  /* RESULTS */
  #screen-results {
    justify-content: flex-start;
    align-items: center;
    text-align: center;
    gap: 0;
    height: auto;
    min-height: 100vh;
    overflow-y: auto;
    padding-bottom: 40px;
  }

  .result-emoji { font-size: 64px; margin-bottom: 16px; }
  .result-title {
    font-size: 28px;
    font-weight: 900;
    letter-spacing: -1px;
    margin-bottom: 8px;
  }
  .result-sub { font-size: 16px; color: var(--text2); margin-bottom: 32px; line-height: 1.5; }

  .match-card {
    background: var(--green-light);
    border-radius: 24px;
    padding: 24px 32px;
    margin-bottom: 24px;
    width: 100%;
  }

  .match-card-emoji { font-size: 56px; margin-bottom: 8px; }
  .match-card-name { font-size: 24px; font-weight: 800; color: var(--text); }

  .order-btns {
    display: flex;
    gap: 10px;
    width: 100%;
    margin-bottom: 16px;
  }

  .order-btn {
    flex: 1;
    padding: 14px 8px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 16px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: transform 0.15s;
    text-decoration: none;
    display: flex; align-items: center; justify-content: center;
  }
  .order-btn:hover { transform: scale(1.04); }

  .partial-matches {
    width: 100%;
    background: var(--bg2);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .partial-match-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #E8DDD0;
  }
  .partial-match-row:last-child { border-bottom: none; }

  .partial-left { display: flex; align-items: center; gap: 10px; font-weight: 600; }
  .partial-count { font-size: 13px; color: var(--text2); }

  .restart-btn {
    background: transparent;
    border: 2px solid #E8DDD0;
    color: var(--text2);
    border-radius: var(--radius);
    padding: 14px 24px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    margin-top: 8px;
  }

  /* TOAST */
  .toast {
    position: fixed;
    bottom: 32px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--text);
    color: white;
    padding: 12px 20px;
    border-radius: 14px;
    font-size: 14px;
    font-weight: 600;
    z-index: 1000;
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    white-space: nowrap;
    max-width: 320px;
    text-align: center;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  /* CONFETTI */
  #confetti-canvas {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: 500;
  }

  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 0; }

  /* Loading */
  .loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    gap: 16px;
  }

  .spinner {
    width: 40px; height: 40px;
    border: 3px solid var(--bg2);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .error-box {
    background: #FFE0E0;
    border-radius: 16px;
    padding: 16px 20px;
    margin: 16px 0;
    font-size: 14px;
    color: #C0392B;
    text-align: center;
  }
</style>
</head>
<body>
<canvas id="confetti-canvas"></canvas>
<div id="app">

  <!-- LANDING -->
  <div id="screen-landing" class="screen active">
    <div class="landing-emoji">üçï</div>
    <h1 class="landing-title">g≈Çodnajestem</h1>
    <p class="landing-sub">wybierzcie razem co zamawiaƒá.<br>bo zawsze kto≈õ m√≥wi "nie wiem, cokolwiek"</p>
    <button class="btn-primary" onclick="showScreen('setup')">zacznij sesjƒô üöÄ</button>
    <button class="btn-secondary" onclick="showScreen('join')">mam link od kogo≈õ ‚Üí</button>
  </div>

  <!-- SETUP -->
  <div id="screen-setup" class="screen">
    <div class="screen-header">
      <button class="back-btn" onclick="showScreen('landing')">‚Üê</button>
      <h2 class="screen-title">kim jeste≈õ? üëÄ</h2>
    </div>

    <div class="label">wybierz awatar</div>
    <div class="avatar-grid" id="avatar-grid-setup">
      <!-- filled by JS -->
    </div>

    <div class="label">albo wpisz nick</div>
    <input class="text-input" id="setup-nick" placeholder="np. G≈Çodna Zosia" maxlength="20">

    <div class="label">ile os√≥b gra?</div>
    <div class="players-row">
      <button class="player-count-btn selected" data-count="2" onclick="selectPlayerCount(2)">2<span>para / roomie</span></button>
      <button class="player-count-btn" data-count="3" onclick="selectPlayerCount(3)">3<span>trio</span></button>
      <button class="player-count-btn" data-count="4" onclick="selectPlayerCount(4)">4<span>ekipa</span></button>
    </div>

    <button class="btn-primary-sm" id="create-session-btn" onclick="createSession()">stw√≥rz sesjƒô ‚ú®</button>
  </div>

  <!-- JOIN -->
  <div id="screen-join" class="screen">
    <div class="screen-header">
      <button class="back-btn" onclick="showScreen('landing')">‚Üê</button>
      <h2 class="screen-title">do≈ÇƒÖcz do sesji</h2>
    </div>

    <div class="label">kod sesji (6 liter)</div>
    <input class="text-input join-code-input" id="join-code" placeholder="ABCXYZ" maxlength="6"
      oninput="this.value = this.value.toUpperCase().replace(/[^A-Z]/g,'')">

    <div class="label">wybierz awatar</div>
    <div class="avatar-grid" id="avatar-grid-join"></div>

    <div class="label">albo wpisz nick</div>
    <input class="text-input" id="join-nick" placeholder="np. Zawsze pizza" maxlength="20">

    <button class="btn-primary-sm" id="join-session-btn" onclick="joinSession()">do≈ÇƒÖczam üôå</button>

    <div id="join-error" class="error-box" style="display:none"></div>
  </div>

  <!-- WAITING ROOM -->
  <div id="screen-waiting" class="screen">
    <div class="screen-header">
      <div style="width:40px"></div>
      <h2 class="screen-title">poczekalnia üõãÔ∏è</h2>
    </div>

    <div class="session-code-box">
      <div class="session-code-label">kod sesji</div>
      <div class="session-code" id="display-code">------</div>
      <div class="share-hint">wy≈õlij znajomym ≈ºeby do≈ÇƒÖczyli üëá</div>
      <button class="copy-link-btn" onclick="copyLink()">üìã kopiuj link</button>
    </div>

    <div class="players-label">gracze</div>
    <div class="players-list" id="players-list">
      <!-- filled dynamically -->
    </div>

    <div class="start-btn-container" id="start-btn-container" style="display:none">
      <button class="btn-primary-sm" id="start-game-btn" onclick="startGame()">startujemy! üéâ</button>
      <p class="waiting-note" id="waiting-note">czekamy na wiƒôcej graczy...</p>
    </div>
  </div>

  <!-- GAME -->
  <div id="screen-game" class="screen">
    <div class="game-header">
      <div class="avatars-row" id="game-avatars"></div>
      <div class="timer" id="game-timer">10:00</div>
      <div class="progress-text" id="game-progress">0/17</div>
    </div>

    <div class="card-area" id="card-area">
      <!-- filled dynamically -->
    </div>
  </div>

  <!-- RESULTS -->
  <div id="screen-results" class="screen">
    <div id="results-content">
      <!-- filled dynamically -->
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
// ============================================================
// SUPABASE CONFIG
// ============================================================
const SUPABASE_URL = 'https://hzsbtzeuzbqpoxqoewsa.supabase.co';
const SUPABASE_KEY = 'sb_publishable_LuXYkxxrGLYBSaP4-8vY9A_x27Q8SyH';
const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

// ============================================================
// CONSTANTS
// ============================================================
const AVATARS = ['üòã','ü§§','üò©','ü•∫','üî•','üòé','ü•±','üò§','üëë','üåö','ü§°','üëª','ü¶ä','üêª','üå∏','‚ö°'];

const FOOD_CATEGORIES = [
  { id: 'pizza', emoji: 'üçï', name: 'Pizza', tagline: 'bo zawsze dzia≈Ça' },
  { id: 'kebab', emoji: 'üåØ', name: 'Kebab', tagline: 'wieczny klasyk po 19:00' },
  { id: 'sushi', emoji: 'üç£', name: 'Sushi', tagline: 'drogo ale warto' },
  { id: 'burger', emoji: 'üçî', name: 'Burger', tagline: 'niezniszczalny faworyt' },
  { id: 'thai', emoji: 'üçú', name: 'Tajskie', tagline: 'pad thai robi robotƒô' },
  { id: 'chinese', emoji: 'ü•°', name: 'Chi≈Ñskie', tagline: 'dim sum > wszystko' },
  { id: 'indian', emoji: 'üçõ', name: 'Indyjskie', tagline: 'curry na stres' },
  { id: 'mexican', emoji: 'üåÆ', name: 'Meksyka≈Ñskie', tagline: 'guacamole w zestawie' },
  { id: 'salad', emoji: 'ü•ó', name: 'Sa≈Çatka', tagline: 'serio? naprawdƒô sa≈Çatka?' },
  { id: 'ramen', emoji: 'üçú', name: 'Ramen', tagline: 'dusza w misce zupy' },
  { id: 'pierogi', emoji: 'ü•ü', name: 'Pierogi', tagline: 'klasyk nie do pobicia' },
  { id: 'pasta', emoji: 'üçù', name: 'Pasta', tagline: 'carbonara albo nic' },
  { id: 'pancakes', emoji: 'ü•û', name: 'Nale≈õniki', tagline: 'kolacja dla leniwych' },
  { id: 'wraps', emoji: 'üåØ', name: 'Wrapy', tagline: 'fit z duszƒÖ' },
  { id: 'dessert', emoji: 'üç∞', name: 'Deser', tagline: 'bo wiecz√≥r tego wymaga' },
  { id: 'gyros', emoji: 'üßÜ', name: 'Gyros', tagline: 'kebab w lepszym wydaniu' },
  { id: 'poke', emoji: 'ü•£', name: 'Poke Bowl', tagline: 'instagram w misce' },
];

const PROVOCATIONS = [
  'ü§î czy naprawdƒô macie ochotƒô na kolejnƒÖ pizzƒô?',
  'üí° co powiedzie na co≈õ zupe≈Çnie innego tym razem?',
  'üé≤ mo≈ºe warto zaryzykowaƒá co≈õ nowego?',
  'üòè kto≈õ tu serio rozwa≈ºa sa≈Çatkƒô o tej porze?',
  'üçï pizza to zawsze dobry pomys≈Ç. zawsze.',
  '‚è∞ zdecydujcie siƒô, zanim wszyscy za≈õniecie',
  'üî• g≈Ç√≥d ro≈õnie z ka≈ºdƒÖ sekundƒÖ',
];

const GAME_DURATION = 10 * 60; // 10 minutes in seconds

// ============================================================
// STATE
// ============================================================
let state = {
  selectedAvatar: null,
  selectedPlayerCount: 2,
  sessionId: null,
  playerId: null,
  isHost: false,
  players: [],
  currentCardIndex: 0,
  votes: {},
  gameStarted: false,
  timerInterval: null,
  timeLeft: GAME_DURATION,
  subscription: null,
  sessionData: null,
  allVotes: {}, // playerId -> votes object
  myVotingDone: false,
};

// ============================================================
// SCREENS
// ============================================================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + id).classList.add('active');
}

// ============================================================
// AVATAR SETUP
// ============================================================
function initAvatarGrids() {
  ['setup', 'join'].forEach(prefix => {
    const grid = document.getElementById('avatar-grid-' + prefix);
    grid.innerHTML = '';
    AVATARS.forEach((emoji, i) => {
      const btn = document.createElement('button');
      btn.className = 'avatar-btn';
      btn.textContent = emoji;
      btn.onclick = () => selectAvatar(emoji, prefix);
      grid.appendChild(btn);
    });
  });
}

function selectAvatar(emoji, prefix) {
  state.selectedAvatar = emoji;
  document.querySelectorAll('#avatar-grid-' + prefix + ' .avatar-btn').forEach(btn => {
    btn.classList.toggle('selected', btn.textContent === emoji);
  });
  // Sync both grids
  const otherPrefix = prefix === 'setup' ? 'join' : 'setup';
  document.querySelectorAll('#avatar-grid-' + otherPrefix + ' .avatar-btn').forEach(btn => {
    btn.classList.toggle('selected', btn.textContent === emoji);
  });
}

function selectPlayerCount(n) {
  state.selectedPlayerCount = n;
  document.querySelectorAll('.player-count-btn').forEach(btn => {
    btn.classList.toggle('selected', parseInt(btn.dataset.count) === n);
  });
}

// ============================================================
// HELPERS
// ============================================================
function generateCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
  return code;
}

function generateId() {
  return Math.random().toString(36).substr(2, 12);
}

function getDisplayName(prefix) {
  const nick = document.getElementById(prefix + '-nick').value.trim();
  return nick || (state.selectedAvatar || 'üòã') + ' Gracz';
}

function showToast(msg, duration = 2500) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

function copyLink() {
  const url = window.location.href.split('?')[0] + '?join=' + state.sessionId;
  navigator.clipboard.writeText(url).then(() => showToast('üìã link skopiowany!'));
}

// ============================================================
// CREATE SESSION
// ============================================================
async function createSession() {
  const btn = document.getElementById('create-session-btn');
  btn.disabled = true;
  btn.textContent = 'tworzƒô...';

  const avatar = state.selectedAvatar || 'üòã';
  const name = getDisplayName('setup');
  const code = generateCode();
  const playerId = generateId();
  const expiresAt = new Date(Date.now() + GAME_DURATION * 1000 + 5 * 60 * 1000).toISOString();

  try {
    // Create session
    const { error: sessionErr } = await db.from('sessions').insert({
      id: code,
      expires_at: expiresAt,
      host_name: name,
      host_avatar: avatar,
      status: 'waiting',
      max_players: state.selectedPlayerCount,
      food_categories: FOOD_CATEGORIES.map(c => c.id),
    });

    if (sessionErr) throw sessionErr;

    // Create host player
    const { error: playerErr } = await db.from('players').insert({
      id: playerId,
      session_id: code,
      name: name,
      avatar: avatar,
      is_host: true,
      votes: {},
    });

    if (playerErr) throw playerErr;

    state.sessionId = code;
    state.playerId = playerId;
    state.isHost = true;

    sessionStorage.setItem('glodna_player_id', playerId);
    sessionStorage.setItem('glodna_session_id', code);

    document.getElementById('display-code').textContent = code;

    await loadPlayers();
    subscribeToSession();
    showScreen('waiting');

  } catch (err) {
    console.error(err);
    showToast('‚ùå b≈ÇƒÖd: ' + (err.message || 'spr√≥buj jeszcze raz'));
  }

  btn.disabled = false;
  btn.textContent = 'stw√≥rz sesjƒô ‚ú®';
}

// ============================================================
// JOIN SESSION
// ============================================================
async function joinSession() {
  const code = document.getElementById('join-code').value.trim().toUpperCase();
  const btn = document.getElementById('join-session-btn');
  const errorDiv = document.getElementById('join-error');
  errorDiv.style.display = 'none';

  if (code.length !== 6) {
    errorDiv.textContent = 'podaj 6-literowy kod sesji';
    errorDiv.style.display = 'block';
    return;
  }

  btn.disabled = true;
  btn.textContent = 'do≈ÇƒÖczam...';

  const avatar = state.selectedAvatar || 'üòã';
  const name = getDisplayName('join');
  const playerId = generateId();

  try {
    // Check session exists
    const { data: session, error: sessionErr } = await db
      .from('sessions')
      .select('*')
      .eq('id', code)
      .single();

    if (sessionErr || !session) throw new Error('nie znaleziono sesji o tym kodzie');
    if (session.status === 'finished') throw new Error('ta sesja ju≈º siƒô zako≈Ñczy≈Ça');

    // Check if full
    const { data: existing } = await db.from('players').select('id').eq('session_id', code);
    if (existing && existing.length >= session.max_players) throw new Error('sesja jest pe≈Çna! üòÖ');

    // Join
    const { error: playerErr } = await db.from('players').insert({
      id: playerId,
      session_id: code,
      name: name,
      avatar: avatar,
      is_host: false,
      votes: {},
    });

    if (playerErr) throw playerErr;

    state.sessionId = code;
    state.playerId = playerId;
    state.isHost = false;
    state.sessionData = session;

    sessionStorage.setItem('glodna_player_id', playerId);
    sessionStorage.setItem('glodna_session_id', code);

    document.getElementById('display-code').textContent = code;

    if (session.status === 'active') {
      // Game already started, jump in
      await loadPlayers();
      subscribeToSession();
      startGameUI();
    } else {
      await loadPlayers();
      subscribeToSession();
      showScreen('waiting');
    }

  } catch (err) {
    errorDiv.textContent = err.message || 'co≈õ posz≈Ço nie tak';
    errorDiv.style.display = 'block';
  }

  btn.disabled = false;
  btn.textContent = 'do≈ÇƒÖczam üôå';
}

// ============================================================
// LOAD PLAYERS
// ============================================================
async function loadPlayers() {
  const { data } = await db.from('players').select('*').eq('session_id', state.sessionId);
  if (data) {
    state.players = data;
    renderWaitingPlayers();
    renderGameAvatars();
  }
}

function renderWaitingPlayers() {
  const { data: session } = state;
  const maxPlayers = state.sessionData ? state.sessionData.max_players : state.selectedPlayerCount;
  const list = document.getElementById('players-list');
  list.innerHTML = '';

  state.players.forEach(p => {
    const row = document.createElement('div');
    row.className = 'player-row';
    row.innerHTML = `
      <span class="player-avatar">${p.avatar}</span>
      <span class="player-name">${p.name}</span>
      ${p.is_host ? '<span class="host-badge">host</span>' : ''}
    `;
    list.appendChild(row);
  });

  // Empty slots
  for (let i = state.players.length; i < maxPlayers; i++) {
    const slot = document.createElement('div');
    slot.className = 'waiting-slot';
    slot.innerHTML = `<span style="font-size:24px">üë§</span> <span>czekamy...</span>`;
    list.appendChild(slot);
  }

  // Start button (host only)
  const startContainer = document.getElementById('start-btn-container');
  const startBtn = document.getElementById('start-game-btn');
  const note = document.getElementById('waiting-note');

  if (state.isHost) {
    startContainer.style.display = 'block';
    if (state.players.length >= 2) {
      startBtn.disabled = false;
      note.textContent = `grajƒÖ ${state.players.length} z ${maxPlayers} os√≥b ‚Äî mo≈ºna startowaƒá!`;
    } else {
      startBtn.disabled = true;
      note.textContent = 'czekamy na co najmniej 2 graczy...';
    }
  }
}

function renderGameAvatars() {
  const container = document.getElementById('game-avatars');
  container.innerHTML = '';
  state.players.forEach(p => {
    const chip = document.createElement('div');
    chip.className = 'avatar-chip';
    chip.id = 'avatar-chip-' + p.id;
    chip.textContent = p.avatar;
    container.appendChild(chip);
  });
}

// ============================================================
// REALTIME SUBSCRIPTION
// ============================================================
function subscribeToSession() {
  if (state.subscription) state.subscription.unsubscribe();

  state.subscription = db
    .channel('session-' + state.sessionId)
    .on('postgres_changes', { event: '*', schema: 'public', table: 'players', filter: 'session_id=eq.' + state.sessionId }, handlePlayerChange)
    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'sessions', filter: 'id=eq.' + state.sessionId }, handleSessionChange)
    .subscribe();
}

async function handlePlayerChange(payload) {
  await loadPlayers();

  if (payload.eventType === 'INSERT' && payload.new.id !== state.playerId) {
    showToast(`${payload.new.avatar} ${payload.new.name} do≈ÇƒÖczy≈Ç!`);
  }

  // Check if all players voted
  if (state.gameStarted) {
    checkAllVotesDone();
  }
}

async function handleSessionChange(payload) {
  if (payload.new.status === 'active' && !state.gameStarted) {
    state.sessionData = payload.new;
    await loadPlayers();
    startGameUI();
  }
  if (payload.new.status === 'finished') {
    showResults(payload.new.results);
  }
}

// ============================================================
// START GAME
// ============================================================
async function startGame() {
  const btn = document.getElementById('start-game-btn');
  btn.disabled = true;
  btn.textContent = 'startujemy...';

  try {
    const { error } = await db.from('sessions').update({ status: 'active' }).eq('id', state.sessionId);
    if (error) throw error;
    startGameUI();
  } catch (err) {
    showToast('b≈ÇƒÖd: ' + err.message);
    btn.disabled = false;
    btn.textContent = 'startujemy! üéâ';
  }
}

function startGameUI() {
  state.gameStarted = true;
  state.currentCardIndex = 0;
  state.votes = {};
  state.timeLeft = GAME_DURATION;

  showScreen('game');
  renderGameAvatars();
  renderCard();
  startTimer();
}

// ============================================================
// TIMER
// ============================================================
function startTimer() {
  if (state.timerInterval) clearInterval(state.timerInterval);
  updateTimerDisplay();

  state.timerInterval = setInterval(() => {
    state.timeLeft--;
    updateTimerDisplay();

    if (state.timeLeft <= 0) {
      clearInterval(state.timerInterval);
      finishVoting();
    }
  }, 1000);
}

function updateTimerDisplay() {
  const mins = Math.floor(state.timeLeft / 60).toString().padStart(2, '0');
  const secs = (state.timeLeft % 60).toString().padStart(2, '0');
  const timerEl = document.getElementById('game-timer');
  timerEl.textContent = mins + ':' + secs;
  timerEl.classList.toggle('urgent', state.timeLeft <= 30);
}

// ============================================================
// CARD RENDERING & SWIPING
// ============================================================
let isDragging = false;
let startX = 0;
let currentX = 0;
let cardEl = null;

function renderCard() {
  const area = document.getElementById('card-area');
  const progress = document.getElementById('game-progress');

  if (state.myVotingDone || state.currentCardIndex >= FOOD_CATEGORIES.length) {
    // Show waiting
    area.innerHTML = `
      <div class="waiting-votes">
        <div style="font-size:48px;margin-bottom:12px">‚è≥</div>
        <div class="waiting-votes-title">g≈Çosujesz szybko!</div>
        <div class="waiting-votes-sub">czekamy a≈º inni sko≈ÑczƒÖ...<br>zosta≈Ço ${state.timeLeft >= 60 ? Math.ceil(state.timeLeft/60) + ' min' : state.timeLeft + ' sek'}</div>
      </div>
    `;
    saveVotes();
    return;
  }

  const cat = FOOD_CATEGORIES[state.currentCardIndex];
  progress.textContent = (state.currentCardIndex) + '/' + FOOD_CATEGORIES.length;

  // Maybe show provocation
  let provHTML = '';
  if (state.currentCardIndex > 0 && state.currentCardIndex % 4 === 0) {
    const p = PROVOCATIONS[Math.floor(Math.random() * PROVOCATIONS.length)];
    provHTML = `<div class="provocation">${p}</div>`;
  }

  area.innerHTML = `
    ${provHTML}
    <div class="swipe-card" id="swipe-card">
      <span class="vote-indicator vote-yes" id="vote-yes">TAK üíö</span>
      <span class="vote-indicator vote-no" id="vote-no">NIE üíî</span>
      <span class="card-emoji">${cat.emoji}</span>
      <div class="card-name">${cat.name}</div>
      <div class="card-tagline">${cat.tagline}</div>
    </div>
    <div class="swipe-hints">
      <button class="vote-btn vote-btn-no" onclick="voteNo()">
        <span class="vote-btn-emoji">üíî</span>
        <span class="vote-btn-label">NIE</span>
      </button>
      <button class="vote-btn vote-btn-yes" onclick="voteYes()">
        <span class="vote-btn-emoji">üíö</span>
        <span class="vote-btn-label">TAK</span>
      </button>
    </div>
  `;

  cardEl = document.getElementById('swipe-card');
  addSwipeListeners(cardEl);
}

function addSwipeListeners(el) {
  // Touch
  el.addEventListener('touchstart', onDragStart, { passive: true });
  el.addEventListener('touchmove', onDragMove, { passive: true });
  el.addEventListener('touchend', onDragEnd);
  // Mouse
  el.addEventListener('mousedown', onDragStart);
  document.addEventListener('mousemove', onDragMoveDoc);
  document.addEventListener('mouseup', onDragEndDoc);
}

function onDragStart(e) {
  isDragging = true;
  startX = e.touches ? e.touches[0].clientX : e.clientX;
  currentX = 0;
  if (cardEl) cardEl.style.transition = 'none';
}

function onDragMove(e) {
  if (!isDragging || !cardEl) return;
  const x = e.touches ? e.touches[0].clientX : e.clientX;
  currentX = x - startX;
  const rotation = currentX * 0.08;
  cardEl.style.transform = `translateX(${currentX}px) rotate(${rotation}deg)`;

  const yesEl = document.getElementById('vote-yes');
  const noEl = document.getElementById('vote-no');

  if (currentX > 40) {
    if (yesEl) yesEl.style.opacity = Math.min((currentX - 40) / 80, 1);
    if (noEl) noEl.style.opacity = 0;
  } else if (currentX < -40) {
    if (noEl) noEl.style.opacity = Math.min((-currentX - 40) / 80, 1);
    if (yesEl) yesEl.style.opacity = 0;
  } else {
    if (yesEl) yesEl.style.opacity = 0;
    if (noEl) noEl.style.opacity = 0;
  }
}

function onDragMoveDoc(e) {
  if (!isDragging) return;
  onDragMove(e);
}

function onDragEnd(e) {
  if (!isDragging || !cardEl) return;
  isDragging = false;
  handleSwipeEnd();
}

function onDragEndDoc(e) {
  if (!isDragging) return;
  isDragging = false;
  handleSwipeEnd();
}

function handleSwipeEnd() {
  document.removeEventListener('mousemove', onDragMoveDoc);
  document.removeEventListener('mouseup', onDragEndDoc);

  if (!cardEl) return;

  const threshold = 80;
  if (currentX > threshold) {
    animateCardOut('right', true);
  } else if (currentX < -threshold) {
    animateCardOut('left', false);
  } else {
    // Snap back
    cardEl.style.transition = 'transform 0.4s cubic-bezier(0.34,1.56,0.64,1)';
    cardEl.style.transform = 'translateX(0) rotate(0deg)';
    const yesEl = document.getElementById('vote-yes');
    const noEl = document.getElementById('vote-no');
    if (yesEl) yesEl.style.opacity = 0;
    if (noEl) noEl.style.opacity = 0;
  }
}

function voteYes() {
  animateCardOut('right', true);
}

function voteNo() {
  animateCardOut('left', false);
}

function animateCardOut(direction, vote) {
  if (!cardEl) return;
  const xTarget = direction === 'right' ? window.innerWidth : -window.innerWidth;
  cardEl.style.transition = 'transform 0.35s ease, opacity 0.35s ease';
  cardEl.style.transform = `translateX(${xTarget}px) rotate(${direction === 'right' ? 20 : -20}deg)`;
  cardEl.style.opacity = '0';

  const cat = FOOD_CATEGORIES[state.currentCardIndex];
  state.votes[cat.id] = vote;

  setTimeout(() => {
    state.currentCardIndex++;
    renderCard();
    document.getElementById('game-progress').textContent = state.currentCardIndex + '/' + FOOD_CATEGORIES.length;

    if (state.currentCardIndex >= FOOD_CATEGORIES.length) {
      state.myVotingDone = true;
      saveVotes();
    }
  }, 350);
}

// ============================================================
// SAVE VOTES TO SUPABASE
// ============================================================
async function saveVotes() {
  try {
    await db.from('players').update({ votes: state.votes }).eq('id', state.playerId);
    // Mark avatar as done
    const chip = document.getElementById('avatar-chip-' + state.playerId);
    if (chip) chip.classList.add('done');
    checkAllVotesDone();
  } catch (err) {
    console.error('save votes error', err);
  }
}

async function checkAllVotesDone() {
  // Reload players
  const { data: players } = await db.from('players').select('*').eq('session_id', state.sessionId);
  if (!players) return;

  // Update avatar done status
  players.forEach(p => {
    const chip = document.getElementById('avatar-chip-' + p.id);
    if (chip && p.votes && Object.keys(p.votes).length >= FOOD_CATEGORIES.length) {
      chip.classList.add('done');
    }
  });

  const allDone = players.every(p => p.votes && Object.keys(p.votes).length >= FOOD_CATEGORIES.length);

  if (allDone && state.isHost) {
    // Calculate results
    clearInterval(state.timerInterval);
    const results = calculateResults(players);
    await db.from('sessions').update({ status: 'finished', results }).eq('id', state.sessionId);
    showResults(results);
  }
}

// ============================================================
// CALCULATE RESULTS
// ============================================================
function calculateResults(players) {
  const tallies = {};
  FOOD_CATEGORIES.forEach(cat => { tallies[cat.id] = 0; });

  players.forEach(p => {
    if (!p.votes) return;
    Object.entries(p.votes).forEach(([catId, vote]) => {
      if (vote) tallies[catId]++;
    });
  });

  const totalPlayers = players.length;
  const matches = FOOD_CATEGORIES
    .filter(cat => tallies[cat.id] === totalPlayers)
    .map(cat => cat.id);

  const partial = FOOD_CATEGORIES
    .filter(cat => tallies[cat.id] > 0 && tallies[cat.id] < totalPlayers)
    .sort((a, b) => tallies[b.id] - tallies[a.id])
    .slice(0, 5)
    .map(cat => ({ id: cat.id, count: tallies[cat.id] }));

  return { matches, partial, total: totalPlayers };
}

// ============================================================
// FINISH VOTING (TIMER RUNS OUT)
// ============================================================
async function finishVoting() {
  // Save whatever votes we have
  await saveVotes();
  if (state.isHost) {
    const { data: players } = await db.from('players').select('*').eq('session_id', state.sessionId);
    if (players) {
      const results = calculateResults(players);
      await db.from('sessions').update({ status: 'finished', results }).eq('id', state.sessionId);
      showResults(results);
    }
  }
}

// ============================================================
// SHOW RESULTS
// ============================================================
function showResults(results) {
  if (!results) return;
  clearInterval(state.timerInterval);
  showScreen('results');

  const container = document.getElementById('results-content');

  if (results.matches && results.matches.length > 0) {
    // FULL MATCH!
    const matchCat = FOOD_CATEGORIES.find(c => c.id === results.matches[0]);
    launchConfetti();

    let otherMatches = results.matches.slice(1).map(id => {
      const c = FOOD_CATEGORIES.find(x => x.id === id);
      return c ? c.emoji + ' ' + c.name : '';
    }).filter(Boolean);

    container.innerHTML = `
      <div class="result-emoji">üéâ</div>
      <div class="result-title">MACIE TO SAMO!</div>
      <div class="result-sub">wszyscy chcƒÖ dzisiaj:<br>${otherMatches.length > 0 ? 'a te≈º: ' + otherMatches.join(', ') : ''}</div>
      <div class="match-card">
        <div class="match-card-emoji">${matchCat.emoji}</div>
        <div class="match-card-name">${matchCat.name}</div>
      </div>
      <div class="order-btns">
        <a href="https://www.pyszne.pl" target="_blank" class="order-btn">üç¥ Pyszne</a>
        <a href="https://www.glovo.com/pl" target="_blank" class="order-btn">‚ö° Glovo</a>
        <a href="https://wolt.com/pl/pol" target="_blank" class="order-btn">üõµ Wolt</a>
      </div>
      <button class="restart-btn" onclick="restartGame()">zagrajcie jeszcze raz üîÑ</button>
    `;
  } else if (results.partial && results.partial.length > 0) {
    // PARTIAL MATCH
    container.innerHTML = `
      <div class="result-emoji">ü§è</div>
      <div class="result-title">prawie!</div>
      <div class="result-sub">nie wszyscy siƒô zgadzajƒÖ, ale co≈õ jest na stole</div>
      <div class="partial-matches">
        ${results.partial.map(p => {
          const cat = FOOD_CATEGORIES.find(c => c.id === p.id);
          if (!cat) return '';
          return `
            <div class="partial-match-row">
              <div class="partial-left">
                <span style="font-size:24px">${cat.emoji}</span>
                <span>${cat.name}</span>
              </div>
              <span class="partial-count">${p.count}/${results.total} os√≥b</span>
            </div>
          `;
        }).join('')}
      </div>
      <div class="order-btns">
        <a href="https://www.pyszne.pl" target="_blank" class="order-btn">üç¥ Pyszne</a>
        <a href="https://wolt.com/pl/pol" target="_blank" class="order-btn">üõµ Wolt</a>
      </div>
      <button class="restart-btn" onclick="restartGame()">spr√≥bujcie jeszcze raz üîÑ</button>
    `;
  } else {
    // NO MATCH
    container.innerHTML = `
      <div class="result-emoji">üò¨</div>
      <div class="result-title">nikt siƒô na nic nie zgadza</div>
      <div class="result-sub">klasyk. mo≈ºe jednak ta sa≈Çatka?</div>
      <button class="btn-primary" onclick="coinFlip()" style="margin-top:24px">ü™ô rzuƒá monetƒÖ</button>
      <button class="restart-btn" style="margin-top:12px" onclick="restartGame()">spr√≥bujcie jeszcze raz üîÑ</button>
    `;
  }
}

function coinFlip() {
  const randomCat = FOOD_CATEGORIES[Math.floor(Math.random() * FOOD_CATEGORIES.length)];
  showToast(`ü™ô moneta m√≥wi: ${randomCat.emoji} ${randomCat.name}!`, 4000);
}

async function restartGame() {
  // Reset session
  state.votes = {};
  state.currentCardIndex = 0;
  state.myVotingDone = false;
  state.timeLeft = GAME_DURATION;

  if (state.isHost) {
    await db.from('players').update({ votes: {} }).eq('session_id', state.sessionId);
    await db.from('sessions').update({ status: 'active', results: null }).eq('id', state.sessionId);
  }

  startGameUI();
}

// ============================================================
// CONFETTI
// ============================================================
function launchConfetti() {
  const canvas = document.getElementById('confetti-canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  const particles = [];
  const colors = ['#FF6B35','#4CAF7D','#FF8FA3','#FFD700','#6C63FF','#FF3B7F'];

  for (let i = 0; i < 150; i++) {
    particles.push({
      x: Math.random() * canvas.width,
      y: -20,
      w: Math.random() * 10 + 4,
      h: Math.random() * 6 + 3,
      color: colors[Math.floor(Math.random() * colors.length)],
      vx: (Math.random() - 0.5) * 6,
      vy: Math.random() * 4 + 2,
      rot: Math.random() * Math.PI * 2,
      rotV: (Math.random() - 0.5) * 0.2,
    });
  }

  let frame = 0;
  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    particles.forEach(p => {
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();
      p.x += p.vx;
      p.y += p.vy;
      p.vy += 0.1;
      p.rot += p.rotV;
    });
    frame++;
    if (frame < 200) requestAnimationFrame(animate);
    else ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
  animate();
}

// ============================================================
// URL PARAMS ‚Äî auto-fill join code
// ============================================================
function checkUrlParams() {
  const params = new URLSearchParams(window.location.search);
  const joinCode = params.get('join');
  if (joinCode) {
    document.getElementById('join-code').value = joinCode.toUpperCase();
    showScreen('join');
  }
}

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
  initAvatarGrids();
  checkUrlParams();

  // Auto-select first avatar
  selectAvatar('üòã', 'setup');
  selectAvatar('üòã', 'join');
});
</script>
</body>
</html>
